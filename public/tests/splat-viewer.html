<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Splat Viewer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    body { background: #1a1816; }
    #viewer-container { width: 100%; height: 100%; }
    .status {
      position: absolute;
      top: 16px;
      left: 16px;
      background: rgba(0,0,0,0.85);
      color: #d4c5b0;
      padding: 12px 16px;
      border-radius: 8px;
      font-family: system-ui, sans-serif;
      font-size: 13px;
      z-index: 100;
      max-width: 400px;
    }
    .status.loading { border-left: 3px solid #8b6f47; }
    .status.success { border-left: 3px solid #4ade80; }
    .status.error { border-left: 3px solid #f87171; }
    .camera-info {
      position: absolute;
      bottom: 16px;
      left: 16px;
      background: rgba(0,0,0,0.85);
      color: #d4c5b0;
      padding: 12px 16px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      z-index: 100;
    }
    .camera-info button {
      margin-top: 8px;
      padding: 4px 12px;
      background: #8b6f47;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
    }
    .camera-info button:hover { background: #a08759; }
  </style>
</head>
<body>
  <div id="viewer-container"></div>
  <div class="status loading" id="status">Initializing...</div>
  <div class="camera-info" id="camera-info">
    <div id="camera-pos">Position: --</div>
    <div id="camera-target">Target: --</div>
    <button id="copy-camera">Copy Camera</button>
  </div>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
      "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.4.6/build/gaussian-splats-3d.module.js"
    }
  }
  </script>

  <script type="module">
    import * as GaussianSplats3D from '@mkkellogg/gaussian-splats-3d';
    
    const container = document.getElementById('viewer-container');
    const statusEl = document.getElementById('status');
    const cameraPosEl = document.getElementById('camera-pos');
    const cameraTargetEl = document.getElementById('camera-target');
    const copyBtn = document.getElementById('copy-camera');
    
    let viewer = null;
    
    function setStatus(msg, type = 'loading') {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + type;
      console.log('[STATUS]', type, msg);
    }
    
    function formatVec(v) {
      return `[${v.x.toFixed(3)}, ${v.y.toFixed(3)}, ${v.z.toFixed(3)}]`;
    }
    
    function updateCameraDisplay() {
      if (viewer && viewer.camera) {
        const pos = viewer.camera.position;
        const target = viewer.controls?.target || { x: 0, y: 0, z: 0 };
        cameraPosEl.textContent = `Position: ${formatVec(pos)}`;
        cameraTargetEl.textContent = `Target: ${formatVec(target)}`;
      }
      requestAnimationFrame(updateCameraDisplay);
    }
    
    copyBtn.addEventListener('click', () => {
      if (viewer && viewer.camera) {
        const pos = viewer.camera.position;
        const target = viewer.controls?.target || { x: 0, y: 0, z: 0 };
        const data = {
          position: [pos.x, pos.y, pos.z],
          target: [target.x, target.y, target.z]
        };
        navigator.clipboard.writeText(JSON.stringify(data, null, 2));
        copyBtn.textContent = 'Copied!';
        setTimeout(() => copyBtn.textContent = 'Copy Camera', 1500);
      }
    });
    
    async function loadSplat(url) {
      setStatus('Loading splat: ' + url, 'loading');
      
      try {
        // Dispose previous viewer
        if (viewer) {
          viewer.dispose();
          viewer = null;
          container.innerHTML = '';
        }
        
        // Create new viewer
        viewer = new GaussianSplats3D.Viewer({
          cameraUp: [0, 1, 0],
          initialCameraPosition: [0, 2, 5],
          initialCameraLookAt: [0, 0, 0],
          rootElement: container,
          sceneRevealMode: GaussianSplats3D.SceneRevealMode.Instant,
          crossOriginIsolated: false
        });
        
        // Load the splat file
        await viewer.addSplatScene(url, {
          splatAlphaRemovalThreshold: 5,
          showLoadingUI: true,
          progressiveLoad: true
        });
        
        viewer.start();
        
        // Start camera display updates
        updateCameraDisplay();
        
        setStatus('Loaded successfully', 'success');
        
      } catch (err) {
        console.error('Load error:', err);
        setStatus('Error: ' + err.message, 'error');
      }
    }
    
    // Listen for messages from parent
    window.addEventListener('message', (e) => {
      if (e.data && e.data.type === 'load' && e.data.src) {
        loadSplat(e.data.src);
      }
    });
    
    // Load from query param
    const params = new URLSearchParams(window.location.search);
    const src = params.get('src');
    if (src) {
      loadSplat(src);
    } else {
      setStatus('No file specified. Add ?src=/path/to/file.ply', 'error');
    }
  </script>
</body>
</html>
