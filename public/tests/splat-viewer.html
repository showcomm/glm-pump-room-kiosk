<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Splat Viewer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    body { background: #1a1816; }
    #viewer-container { 
      width: 100%; 
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
    .status {
      position: absolute;
      top: 16px;
      left: 16px;
      background: rgba(0,0,0,0.85);
      color: #d4c5b0;
      padding: 12px 16px;
      border-radius: 8px;
      font-family: system-ui, sans-serif;
      font-size: 13px;
      z-index: 100;
      max-width: 400px;
    }
    .status.loading { border-left: 3px solid #8b6f47; }
    .status.success { border-left: 3px solid #4ade80; }
    .status.error { border-left: 3px solid #f87171; }
    .camera-info {
      position: absolute;
      bottom: 16px;
      left: 16px;
      background: rgba(0,0,0,0.85);
      color: #d4c5b0;
      padding: 12px 16px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      z-index: 100;
    }
    .camera-info button {
      margin-top: 8px;
      padding: 4px 12px;
      background: #8b6f47;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
    }
    .camera-info button:hover { background: #a08759; }
  </style>
</head>
<body>
  <div id="viewer-container"></div>
  <div class="status loading" id="status">Initializing PlayCanvas...</div>
  <div class="camera-info" id="camera-info">
    <div id="camera-pos">Position: --</div>
    <div id="camera-target">Target: --</div>
    <button id="copy-camera">Copy Camera</button>
  </div>

  <script type="module">
    import { Viewer } from 'https://esm.sh/@playcanvas/blocks@0.3.7';
    
    const container = document.getElementById('viewer-container');
    const statusEl = document.getElementById('status');
    const cameraPosEl = document.getElementById('camera-pos');
    const cameraTargetEl = document.getElementById('camera-target');
    const copyBtn = document.getElementById('copy-camera');
    
    let viewer = null;
    
    function setStatus(msg, type = 'loading') {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + type;
      console.log('[STATUS]', type, msg);
    }
    
    function formatVec(v) {
      if (!v) return '--';
      return `[${v.x.toFixed(3)}, ${v.y.toFixed(3)}, ${v.z.toFixed(3)}]`;
    }
    
    copyBtn.addEventListener('click', () => {
      if (viewer && viewer.camera) {
        const pos = viewer.camera.getPosition();
        const target = viewer.cameraControls?.focus || { x: 0, y: 0, z: 0 };
        const data = {
          position: [pos.x, pos.y, pos.z],
          target: [target.x, target.y, target.z]
        };
        navigator.clipboard.writeText(JSON.stringify(data, null, 2));
        copyBtn.textContent = 'Copied!';
        setTimeout(() => copyBtn.textContent = 'Copy Camera', 1500);
      }
    });
    
    async function loadSplat(url) {
      setStatus('Loading: ' + url, 'loading');
      
      try {
        // Create PlayCanvas viewer
        viewer = new Viewer(container, {
          graphicsDeviceOptions: {
            antialias: true,
            alpha: false,
            preserveDrawingBuffer: false,
            preferWebGl2: true
          }
        });
        
        console.log('Viewer created:', viewer);
        
        // Load the splat
        await viewer.load(url);
        
        console.log('Splat loaded');
        
        // Update camera display periodically
        setInterval(() => {
          if (viewer && viewer.camera) {
            const pos = viewer.camera.getPosition();
            cameraPosEl.textContent = `Position: ${formatVec(pos)}`;
          }
        }, 100);
        
        setStatus('Loaded', 'success');
        
      } catch (err) {
        console.error('Load error:', err);
        setStatus('Error: ' + err.message, 'error');
      }
    }
    
    // Listen for messages from parent
    window.addEventListener('message', (e) => {
      if (e.data && e.data.type === 'load' && e.data.src) {
        loadSplat(e.data.src);
      }
    });
    
    // Load from query param
    const params = new URLSearchParams(window.location.search);
    const src = params.get('src');
    if (src) {
      loadSplat(src);
    } else {
      setStatus('No file specified. Add ?src=/path/to/file.ply', 'error');
    }
  </script>
</body>
</html>
